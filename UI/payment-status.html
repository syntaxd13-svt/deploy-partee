<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Check Payment Status – PARTEE</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body {font-family:'Lora',serif;background:#f8f9fa;text-align:center;padding-top:80px;}
  .status-box {max-width:500px;margin:0 auto;padding:40px;background:white;border-radius:15px;box-shadow:0 4px 6px rgba(0,0,0,0.1);}
  .spinner {border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:20px auto;}
  @keyframes spin {0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="status-box">
  <div id="checking">
    <div class="spinner"></div>
    <h3>Verifying your payment...</h3>
    <p class="text-muted">Please wait while we confirm your payment with PayMongo.</p>
  </div>
  
  <div id="success" style="display:none">
    <div style="font-size:80px;color:#28a745">✓</div>
    <h2 style="color:#28a745">Payment Confirmed!</h2>
    <p id="successMessage"></p>
    <a href="payment-success.html" class="btn btn-success mt-3" id="viewTicketBtn">View Your Ticket</a>
  </div>
  
  <div id="pending" style="display:none">
    <div style="font-size:80px;color:#ffc107">⏳</div>
    <h2 style="color:#ffc107">Payment Processing</h2>
    <p>Your payment is being processed. This may take a few moments.</p>
    <button class="btn btn-primary mt-3" onclick="checkAgain()">Check Again</button>
    <a href="../index.html" class="btn btn-outline-secondary mt-3">Return to Home</a>
  </div>
  
  <div id="failed" style="display:none">
    <div style="font-size:80px;color:#dc3545">✗</div>
    <h2 style="color:#dc3545">Payment Not Found</h2>
    <p>We couldn't find your payment. It may have been cancelled or is still processing.</p>
    <button class="btn btn-primary mt-3" onclick="checkAgain()">Check Again</button>
    <a href="payment.html" class="btn btn-outline-secondary mt-3">Try Again</a>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const { createClient } = supabase;
const client = createClient(
  "https://qoronghxfdamvuxmbjqx.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFvcm9uZ2h4ZmRhbXZ1eG1ianF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMTA3NjksImV4cCI6MjA3NTg4Njc2OX0.YJqas5o80oWwfzkpbTQ3ci6CxTuQ_nkOobV6sg0NMXg"
);

const params = new URLSearchParams(window.location.search);
const bookingId = params.get("booking_id");
const name = params.get("name");
const amount = params.get("amount");

async function checkPaymentStatus() {
  try {
    const { data: booking, error } = await client
      .from("vip_bookings")
      .select("status")
      .eq("id", bookingId)
      .single();
    
    if (error) throw error;
    
    document.getElementById("checking").style.display = "none";
    
    if (booking.status === "paid") {
      // Payment successful
      document.getElementById("success").style.display = "block";
      document.getElementById("successMessage").textContent = 
        `Thank you, ${name}! Your payment of ₱${parseFloat(amount).toLocaleString()} was successful.`;
      
      // Update the view ticket button with proper query params
      document.getElementById("viewTicketBtn").href = 
        `payment-success.html?booking_id=${bookingId}&name=${encodeURIComponent(name)}&amount=${amount}`;
      
      // Log the payment
      await client.from("payments").insert({
        booking_id: bookingId,
        booking_type: "vip",
        amount: parseFloat(amount),
        method: "GCash",
        status: "completed"
      });
      
    } else if (booking.status === "processing") {
      // Still processing
      document.getElementById("pending").style.display = "block";
    } else {
      // Failed or cancelled
      document.getElementById("failed").style.display = "block";
    }
    
  } catch (err) {
    console.error("Status check failed:", err);
    document.getElementById("checking").style.display = "none";
    document.getElementById("failed").style.display = "block";
  }
}

function checkAgain() {
  document.getElementById("pending").style.display = "none";
  document.getElementById("failed").style.display = "none";
  document.getElementById("checking").style.display = "block";
  setTimeout(checkPaymentStatus, 1000);
}

// Auto-check on load
checkPaymentStatus();
</script>
</body>
</html>