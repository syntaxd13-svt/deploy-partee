<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Check Payment Status – PARTEE</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body {font-family:'Lora',serif;background:#f8f9fa;text-align:center;padding-top:80px;}
  .status-box {max-width:500px;margin:0 auto;padding:40px;background:white;border-radius:15px;box-shadow:0 4px 6px rgba(0,0,0,0.1);}
  .spinner {border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:20px auto;}
  @keyframes spin {0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="status-box">
  <div id="checking">
    <div class="spinner"></div>
    <h3>Verifying your payment...</h3>
    <p class="text-muted">Please wait while we confirm your payment with PayMongo.</p>
  </div>
  
  <div id="success" style="display:none">
    <div style="font-size:80px;color:#28a745">✓</div>
    <h2 style="color:#28a745">Payment Confirmed!</h2>
    <p id="successMessage"></p>
    <a href="payment-success.html" class="btn btn-success mt-3" id="viewTicketBtn">View Your Ticket</a>
  </div>
  
  <div id="pending" style="display:none">
    <div style="font-size:80px;color:#ffc107">⏳</div>
    <h2 style="color:#ffc107">Payment Processing</h2>
    <p>Your payment is being processed. This may take a few moments.</p>
    <button class="btn btn-primary mt-3" onclick="checkAgain()">Check Again</button>
    <a href="../index.html" class="btn btn-outline-secondary mt-3">Return to Home</a>
  </div>
  
  <div id="failed" style="display:none">
    <div style="font-size:80px;color:#dc3545">✗</div>
    <h2 style="color:#dc3545">Payment Not Found</h2>
    <p id="failedMessage">We couldn't find your payment. It may have been cancelled or is still processing.</p>
    <button class="btn btn-primary mt-3" onclick="checkAgain()">Check Again</button>
    <a href="payment.html" class="btn btn-outline-secondary mt-3">Try Again</a>
  </div>

  <div id="error" style="display:none">
    <div style="font-size:80px;color:#dc3545">⚠️</div>
    <h2 style="color:#dc3545">Error</h2>
    <p id="errorMessage"></p>
    <a href="../index.html" class="btn btn-outline-secondary mt-3">Return to Home</a>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const { createClient } = supabase;
const client = createClient(
  "https://qoronghxfdamvuxmbjqx.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFvcm9uZ2h4ZmRhbXZ1eG1ianF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMTA3NjksImV4cCI6MjA3NTg4Njc2OX0.YJqas5o80oWwfzkpbTQ3ci6CxTuQ_nkOobV6sg0NMXg"
);

const params = new URLSearchParams(window.location.search);
let bookingId = params.get("booking_id");
let name = params.get("name");
let amount = params.get("amount");

console.log("payment-status.html - Initial params:", { bookingId, name, amount });

// Fallback to sessionStorage if URL params are missing
if (!bookingId || !name || !amount) {
  const bookingInfo = sessionStorage.getItem('booking_info');
  if (bookingInfo) {
    try {
      const data = JSON.parse(bookingInfo);
      bookingId = data.bookingId;
      name = data.name;
      amount = data.total;
      console.log("Using sessionStorage:", { bookingId, name, amount });
    } catch (e) {
      console.error("Failed to parse sessionStorage:", e);
      showError("Invalid booking data. Please try again.");
    }
  }
}

async function checkPaymentStatus() {
  try {
    if (!bookingId || bookingId === "null") {
      showError("Booking ID is missing or invalid. Please try booking again.");
      return;
    }

    console.log("Checking payment status for booking:", bookingId);

    // Get booking type from sessionStorage or URL
    const bookingInfo = sessionStorage.getItem('booking_info');
    let bookingType = "vip"; // default
    if (bookingInfo) {
      try {
        bookingType = JSON.parse(bookingInfo).bookingType || "vip";
      } catch (e) {
        console.error("Failed to parse booking type:", e);
      }
    }

    // Query the correct table
    const tableName = bookingType === "regular" ? "regular_bookings" : "vip_bookings";
    console.log("Querying table:", tableName);
    
    const { data: booking, error } = await client
      .from(tableName)
      .select("status")
      .eq("id", bookingId)
      .maybeSingle();
    
    if (error) {
      console.error("Query error:", error);
      showError("Unable to check payment status. Please try again.");
      return;
    }
    
    if (!booking) {
      console.log("No booking found with ID:", bookingId);
      document.getElementById("checking").style.display = "none";
      document.getElementById("failed").style.display = "block";
      document.getElementById("failedMessage").textContent = 
        `No booking found. The booking may have expired or been cancelled.`;
      return;
    }
    
    console.log("Booking status:", booking.status);
    document.getElementById("checking").style.display = "none";
    
    if (booking.status === "paid") {
      document.getElementById("success").style.display = "block";
      document.getElementById("successMessage").textContent = 
        `Thank you, ${name}! Your payment of ₱${parseFloat(amount).toLocaleString()} was successful.`;
      
      document.getElementById("viewTicketBtn").href = 
        `payment-success.html?booking_id=${bookingId}&name=${encodeURIComponent(name)}&amount=${amount}`;
      
      // Log payment
      await client.from("payments").insert({
        booking_id: bookingId,
        booking_type: bookingType,
        total_amount: parseFloat(amount),
        payment_method: "GCash",
        status: "paid"
      });
      
      sessionStorage.removeItem('booking_info');
      
    } else if (booking.status === "pending") {
      document.getElementById("pending").style.display = "block";
    } else if (booking.status === "cancelled") {
      document.getElementById("failed").style.display = "block";
      document.getElementById("failedMessage").textContent = 
        `This booking has been cancelled. Please create a new booking.`;
    } else {
      document.getElementById("failed").style.display = "block";
      document.getElementById("failedMessage").textContent = 
        `Payment status: ${booking.status}. Please try again or contact support.`;
    }
    
  } catch (err) {
    console.error("Status check failed:", err);
    showError(`Error: ${err.message}`);
  }
}

function showError(message) {
  document.getElementById("checking").style.display = "none";
  document.getElementById("error").style.display = "block";
  document.getElementById("errorMessage").textContent = message;
}

function checkAgain() {
  document.getElementById("pending").style.display = "none";
  document.getElementById("failed").style.display = "none";
  document.getElementById("error").style.display = "none";
  document.getElementById("checking").style.display = "block";
  setTimeout(checkPaymentStatus, 1500);
}

checkPaymentStatus();
</script>
</body>
</html>