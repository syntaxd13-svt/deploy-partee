<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VIP Seat Selection – PARTEE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: 'Lora', serif;
      background: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    header {
      background: #212529;
      color: #fff;
      text-align: center;
      padding: 40px 0;
    }
    h1 {
      font-family: 'Poppins', sans-serif;
      font-size: 42px;
    }
    .container {
      padding: 40px 15px;
    }
    .table-section {
      text-align: center;
      margin-bottom: 50px;
    }
    .vip-table {
      display: inline-grid;
      grid-template-columns: repeat(4, 60px);
      grid-gap: 10px;
      background: #fff;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin: 20px;
    }
    .seat {
      width: 60px;
      height: 60px;
      line-height: 60px;
      border-radius: 8px;
      text-align: center;
      border: 2px solid #ccc;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      user-select: none;
    }
    .seat:hover {
      border-color: #FFD700;
      background: #fffbe6;
    }
    .seat.selected {
      background: #FFD700;
      color: #000;
      border-color: #ccaa00;
    }
    .seat.reserved {
      background: #ddd;
      color: #777;
      border-color: #aaa;
      cursor: not-allowed;
    }
    .btn-custom {
      background: #FFD700;
      border: none;
      color: #212529;
      padding: 12px 30px;
      border-radius: 25px;
      font-weight: 600;
      transition: background 0.3s;
    }
    .btn-custom:hover {
      background: #e5b700;
    }
  </style>
</head>
<body>
  <header>
    <h1>VIP Seat Selection</h1>
    <p>Select your table and seats below</p>
  </header>

  <div class="container text-center">
    <div class="table-section">
      <h3 class="mb-3">Choose Your Table</h3>
      <div id="tablesContainer"></div>
    </div>

    <button id="confirmBtn" class="btn btn-custom mt-4">Confirm Seats & Proceed to Payment</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const { createClient } = supabase;
    const client = createClient(
      "https://qoronghxfdamvuxmbjqx.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFvcm9uZ2h4ZmRhbXZ1eG1ianF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMTA3NjksImV4cCI6MjA3NTg4Njc2OX0.YJqas5o80oWwfzkpbTQ3ci6CxTuQ_nkOobV6sg0NMXg"
    );

    // URL parameters
    const params = new URLSearchParams(window.location.search);
    const bookingId = params.get("booking_id");
    const name = params.get("name");
    const guestCount = parseInt(params.get("guests")) || 1;

    // Layout: 4 tables, each with 8 seats
    const tables = {
      "VIP A": 8,
      "VIP B": 8,
      "VIP C": 8,
      "VIP D": 8
    };

    const selectedSeats = [];
    const tablesContainer = document.getElementById("tablesContainer");

    // Render all tables
    Object.entries(tables).forEach(([tableName, seatCount]) => {
      const tableDiv = document.createElement("div");
      tableDiv.classList.add("vip-table");
      const title = document.createElement("h5");
      title.textContent = tableName;
      title.style.gridColumn = "span 4";
      tableDiv.appendChild(title);

      for (let i = 1; i <= seatCount; i++) {
        const seat = document.createElement("div");
        seat.className = "seat";
        seat.textContent = `${tableName.split(' ')[1]}-${i}`;
        seat.dataset.table = tableName;

        seat.addEventListener("click", () => handleSeatClick(seat));
        tableDiv.appendChild(seat);
      }

      tablesContainer.appendChild(tableDiv);
    });

    function handleSeatClick(seat) {
      if (seat.classList.contains("reserved")) return;

      const alreadySelected = seat.classList.contains("selected");
      const table = seat.dataset.table;

      if (alreadySelected) {
        seat.classList.remove("selected");
        const index = selectedSeats.findIndex(s => s.code === seat.textContent);
        selectedSeats.splice(index, 1);
      } else {
        // Only allow seats from the same table
        if (selectedSeats.length > 0 && selectedSeats[0].table !== table) {
          alert("⚠️ All guests must sit at the same table.");
          return;
        }

        if (selectedSeats.length >= guestCount) {
          alert(`You can only select ${guestCount} seat(s).`);
          return;
        }

        seat.classList.add("selected");
        selectedSeats.push({ table, code: seat.textContent });
      }
    }

    // Automatically suggest all seats from the same table if user selects one
    function recommendSeats() {
      if (guestCount > 1 && selectedSeats.length === 1) {
        const table = selectedSeats[0].table;
        const allSeats = document.querySelectorAll(`[data-table='${table}']`);
        let needed = guestCount - 1;

        for (let seat of allSeats) {
          if (!seat.classList.contains("selected") && !seat.classList.contains("reserved") && needed > 0) {
            seat.classList.add("selected");
            selectedSeats.push({ table, code: seat.textContent });
            needed--;
          }
        }
      }
    }

    document.getElementById("confirmBtn").addEventListener("click", async () => {
      if (selectedSeats.length === 0) {
        alert("Please select at least one seat.");
        return;
      }

      // If only one chosen, auto-recommend remaining seats from same table
      if (selectedSeats.length < guestCount) recommendSeats();

      try {
        const seatData = selectedSeats.map(s => ({
          booking_id: bookingId,
          table_name: s.table,
          seat_code: s.code
        }));

        const { error } = await client.from("vip_seats").insert(seatData);
        if (error) throw error;

        // Proceed to payment
        window.location.href = `payment.html?booking_id=${bookingId}&name=${encodeURIComponent(name)}&guests=${guestCount}`;
      } catch (err) {
        console.error(err);
        alert("❌ Error saving seat selection: " + err.message);
      }
    });
  </script>
</body>
</html>
