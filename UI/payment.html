<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>VIP Payment – PARTEE</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body {font-family:'Lora',serif;background:#f8f9fa;}
  .header {background:#212529;color:#fff;text-align:center;padding:50px 0;}
  .price-box {background:#FFD700;color:#212529;padding:25px;border-radius:12px;font-weight:600;text-align:center;margin-bottom:30px;}
  .wallet-btn {width:100%;margin-bottom:15px;font-weight:600;border-radius:25px;padding:12px;font-size:1.1rem;}
</style>
</head>
<body>
<header class="header">
  <h1>Complete Your VIP Payment</h1>
</header>

<div class="container py-5" style="max-width:500px">
  <div class="price-box">
    <h4 id="customerName">—</h4>
    <div id="totalPrice" style="font-size:2rem">—</div>
    <p>₱1000 × <span id="guestCount">—</span> guest(s)</p>
  </div>

  <h5 class="text-center mb-3">Choose your payment method</h5>
  <button class="btn btn-primary wallet-btn" onclick="pay('GCash')">Pay with GCash</button>
  <button class="btn btn-success wallet-btn" onclick="pay('Maya')">Pay with Maya</button>
  <button class="btn btn-warning wallet-btn text-dark" onclick="pay('Other')">Pay with Other Method</button>

  <div class="text-center mt-4">
    <button class="btn btn-outline-secondary" onclick="cancel()">Cancel Booking</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const { createClient } = supabase;
const client = createClient(
  "https://qoronghxfdamvuxmbjqx.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFvcm9uZ2h4ZmRhbXZ1eG1ianF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMTA3NjksImV4cCI6MjA3NTg4Njc2OX0.YJqas5o80oWwfzkpbTQ3ci6CxTuQ_nkOobV6sg0NMXg"
);

const params = new URLSearchParams(window.location.search);
const bookingId = params.get("booking_id");
const name = params.get("name");
const guests = parseInt(params.get("guests")) || 1;
const PRICE = 1000;
const total = guests * PRICE;

document.getElementById("customerName").textContent = name;
document.getElementById("guestCount").textContent = guests;
document.getElementById("totalPrice").textContent = "₱" + total.toLocaleString();

async function pay(method) {
  if (method !== "GCash") {
    alert(`Currently only GCash integration is live.`);
    return;
  }

  try {
    // 1️⃣ Create a GCash checkout source through your backend
    const response = await fetch("/api/create-gcash-payment.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        booking_id: bookingId,
        name: name,
        amount: total
      })
    });

    const result = await response.json();
    if (!result.data || !result.data.attributes) throw new Error("Invalid GCash API response.");

    const checkoutUrl = result.data.attributes.redirect.checkout_url;

    // 2️⃣ Mark booking as awaiting payment
    await client.from("vip_bookings").update({ status: "processing" }).eq("id", bookingId);

    // 3️⃣ Redirect to GCash payment page
    window.location.href = checkoutUrl;
  } catch (err) {
    console.error(err);
    alert("❌ Failed to create GCash payment: " + err.message);
  }
}

async function cancel() {
  if (!confirm("Cancel this booking?")) return;
  await client.from("vip_bookings").delete().eq("id", bookingId);
  await client.from("vip_seats").delete().eq("booking_id", bookingId);
  alert("Booking cancelled.");
  window.location.href = "../index.html";
}

// Clean up if user leaves before payment
window.addEventListener("beforeunload", async () => {
  const { data } = await client.from("vip_bookings").select("status").eq("id", bookingId).maybeSingle();
  if (data && data.status === "pending") {
    await client.from("vip_bookings").delete().eq("id", bookingId);
    await client.from("vip_seats").delete().eq("booking_id", bookingId);
  }
});
</script>
</body>
</html>
