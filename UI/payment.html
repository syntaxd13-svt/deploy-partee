<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>VIP Payment – PARTEE</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body {font-family:'Lora',serif;background:#f8f9fa;}
  .header {background:#212529;color:#fff;text-align:center;padding:50px 0;}
  .price-box {background:#FFD700;color:#212529;padding:25px;border-radius:12px;font-weight:600;text-align:center;margin-bottom:30px;}
  .wallet-btn {width:100%;margin-bottom:15px;font-weight:600;border-radius:25px;padding:12px;font-size:1.1rem;}
  .modal-backdrop { background-color: rgba(0,0,0,0.5); }
  .processing-box {text-align:center;padding:40px;}
  .spinner {border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:20px auto;}
  @keyframes spin {0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
</style>
</head>
<body>
<header class="header">
  <h1>Complete Your VIP Payment</h1>
</header>

<div class="container py-5" style="max-width:500px">
  <div class="price-box">
    <h4 id="customerName">–</h4>
    <div id="totalPrice" style="font-size:2rem">–</div>
    <p>₱1000 × <span id="guestCount">–</span> guest(s)</p>
  </div>

  <h5 class="text-center mb-3">Choose your payment method</h5>
  <button class="btn btn-primary wallet-btn" id="gcashBtn" onclick="pay('GCash')">Pay with GCash</button>

  <div class="text-center mt-4">
    <button class="btn btn-outline-secondary" onclick="cancel()">Cancel Booking</button>
  </div>
</div>

<!-- Processing Modal -->
<div class="modal fade" id="processingModal" tabindex="-1" backdrop="static" keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="processing-box">
        <div class="spinner"></div>
        <h4>Payment Processing</h4>
        <p class="text-muted">A payment tab has opened. Please complete your payment.</p>
        <p class="text-muted small">We're monitoring your payment status...</p>
        <button class="btn btn-outline-secondary mt-3" onclick="closeModal()">Return to Booking</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const { createClient } = supabase;
const client = createClient(
  "https://qoronghxfdamvuxmbjqx.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFvcm9uZ2h4ZmRhbXZ1eG1ianF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMTA3NjksImV4cCI6MjA3NTg4Njc2OX0.YJqas5o80oWwfzkpbTQ3ci6CxTuQ_nkOobV6sg0NMXg"
);

const params = new URLSearchParams(window.location.search);
const bookingId = params.get("booking_id") || params.get("id"); // Support both parameter names
const name = params.get("name");
const guests = parseInt(params.get("guests")) || 1;
const PRICE = 1000;
const total = guests * PRICE;

console.log("Page loaded with:", { bookingId, name, guests, total });

let paymentCheckInterval = null;
let processingModal = null;

document.getElementById("customerName").textContent = name;
document.getElementById("guestCount").textContent = guests;
document.getElementById("totalPrice").textContent = "₱" + total.toLocaleString();

// Initialize modal
processingModal = new bootstrap.Modal(document.getElementById('processingModal'), {
  backdrop: 'static',
  keyboard: false
});

async function pay(method) {
  if (method !== "GCash") {
    alert("Currently only GCash integration is supported.");
    return;
  }

  try {
    document.getElementById("gcashBtn").disabled = true;
    
    const requestBody = {
      name: name,
      amount: total * 100,
      description: `VIP Booking for ${name}`,
      booking_id: bookingId
    };
    
    console.log("Sending payment request:", requestBody);
    
    // Call Supabase Edge Function with authorization
    const response = await fetch("https://qoronghxfdamvuxmbjqx.supabase.co/functions/v1/create-payment", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFvcm9uZ2h4ZmRhbXZ1eG1ianF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMTA3NjksImV4cCI6MjA3NTg4Njc2OX0.YJqas5o80oWwfzkpbTQ3ci6CxTuQ_nkOobV6sg0NMXg"
      },
      body: JSON.stringify(requestBody)
    });

    console.log("Response status:", response.status);
    const data = await response.json();
    console.log("Payment response:", data);
    
    if (!response.ok) {
      console.error("Response not ok:", response.status, data);
      throw new Error(`Error: ${data?.error || data?.message || response.statusText}`);
    }
    
    // Handle both payment_links (new) and links (old) response format
    const checkoutUrl = data?.data?.attributes?.checkout_url;
    
    if (checkoutUrl) {
      // Update booking status to "processing"
      const paymentLinkId = data.data.id;
      console.log("Payment Link ID:", paymentLinkId);
      
      const { error: updateError } = await client.from("vip_bookings").update({ 
        status: "processing",
        payment_link_id: paymentLinkId 
      }).eq("id", bookingId);
      
      if (updateError) {
        console.error("Error updating booking:", updateError);
        throw updateError;
      }
      
      console.log("✅ Booking updated to processing with payment_link_id:", paymentLinkId);
      
      // Show processing modal
      processingModal.show();
      
      // Start real-time payment monitoring
      startPaymentMonitoring(paymentLinkId);
      
      // Open PayMongo in a new tab
      console.log("Opening payment URL:", checkoutUrl);
      window.open(checkoutUrl, 'PayMongo_Payment');
      
    } else {
      throw new Error("No checkout URL in response");
    }
  } catch (error) {
    console.error("Payment creation failed:", error);
    alert("Error: " + error.message);
    document.getElementById("gcashBtn").disabled = false;
  }
}

async function verifyAndRecordPayment(paymentLinkId) {
  try {
    console.log("Verifying payment with PayMongo...");
    
    // Call create-payment function to verify status
    const response = await fetch("https://qoronghxfdamvuxmbjqx.supabase.co/functions/v1/verify-payment", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFvcm9uZ2h4ZmRhbXZ1eG1ianF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMTA3NjksImV4cCI6MjA3NTg4Njc2OX0.YJqas5o80oWwfzkpbTQ3ci6CxTuQ_nkOobV6sg0NMXg"
      },
      body: JSON.stringify({
        payment_id: paymentLinkId,
        booking_id: bookingId,
        amount: total
      })
    });
    
    const result = await response.json();
    console.log("Verification result:", result);
    
    if (result.success) {
      console.log("✅ Payment verified and recorded!");
      return true;
    }
    return false;
  } catch (err) {
    console.error("Payment verification error:", err);
    return false;
  }
}

function startPaymentMonitoring() {
  console.log("Starting payment monitoring for booking:", bookingId);
  let attempts = 0;
  const maxAttempts = 120; // 10 minutes with 5 second intervals
  
  paymentCheckInterval = setInterval(async () => {
    attempts++;
    console.log(`Payment check attempt ${attempts}/${maxAttempts}`);
    
    try {
      const { data: booking } = await client
        .from("vip_bookings")
        .select("payment_link_id, status")
        .eq("id", bookingId)
        .single();
      
      if (booking?.payment_link_id) {
        const verified = await verifyAndRecordPayment(booking.payment_link_id);
        
        if (verified) {
          clearInterval(paymentCheckInterval);
          processingModal.hide();
          
          setTimeout(() => {
            window.location.href = `payment-success.html?booking_id=${bookingId}&name=${encodeURIComponent(name)}&amount=${total}`;
          }, 1000);
          return;
        }
      }
      
      if (attempts >= maxAttempts) {
        clearInterval(paymentCheckInterval);
        console.log("Payment monitoring timeout");
      }
    } catch (err) {
      console.error("Monitoring error:", err);
    }
  }, 5000); // Check every 5 seconds
}

function closeModal() {
  processingModal.hide();
  clearInterval(paymentCheckInterval);
  document.getElementById("gcashBtn").disabled = false;
}

async function cancel() {
  if (!confirm("Are you sure you want to cancel this booking?")) return;
  clearInterval(paymentCheckInterval);
  await client.from("vip_bookings").delete().eq("id", bookingId);
  await client.from("vip_seats").delete().eq("booking_id", bookingId);
  alert("Booking cancelled.");
  window.location.href = "../index.html";
}

// Cleanup on page unload
window.addEventListener("beforeunload", async () => {
  clearInterval(paymentCheckInterval);
});
</script>
</body>
</html>