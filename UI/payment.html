<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Payment – PARTEE</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body {font-family:'Lora',serif;background:#f8f9fa;}
  .header {background:#212529;color:#fff;text-align:center;padding:50px 0;}
  .price-box {background:#FFD700;color:#212529;padding:25px;border-radius:12px;font-weight:600;text-align:center;margin-bottom:30px;}
  .wallet-btn {width:100%;margin-bottom:15px;font-weight:600;border-radius:25px;padding:12px;font-size:1.1rem;}
</style>
</head>
<body>
<header class="header">
  <h1 id="headerTitle">Complete Your Payment</h1>
</header>

<div class="container py-5" style="max-width:500px">
  <div class="price-box">
    <h4 id="customerName">–</h4>
    <div id="totalPrice" style="font-size:2rem">–</div>
    <p id="priceBreakdown">–</p>
  </div>

  <h5 class="text-center mb-3">Choose your payment method</h5>
  <button class="btn btn-primary wallet-btn" onclick="pay('GCash')">Pay with GCash</button>

  <div class="text-center mt-4">
    <button class="btn btn-outline-secondary" onclick="cancel()">Cancel Booking</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const { createClient } = supabase;
const client = createClient(
  "https://qoronghxfdamvuxmbjqx.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFvcm9uZ2h4ZmRhbXZ1eG1ianF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMTA3NjksImV4cCI6MjA3NTg4Njc2OX0.YJqas5o80oWwfzkpbTQ3ci6CxTuQ_nkOobV6sg0NMXg"
);

const params = new URLSearchParams(window.location.search);
const bookingId = params.get("booking_id") || params.get("id");
const name = params.get("name");
const guests = parseInt(params.get("guests")) || 1;
const bookingType = params.get("type") || "vip"; // Default to VIP if not specified

// Pricing based on booking type
const PRICE_PER_PERSON = bookingType === "regular" ? 100 : 300;
const total = guests * PRICE_PER_PERSON;

console.log("Payment page loaded:", { bookingId, name, guests, bookingType, total });

// Store in sessionStorage
sessionStorage.setItem('booking_info', JSON.stringify({
  bookingId: bookingId,
  name: name,
  guests: guests,
  total: total,
  bookingType: bookingType
}));

// Update UI
document.getElementById("headerTitle").textContent = 
  `Complete Your ${bookingType === "regular" ? "Regular" : "VIP"} Payment`;
document.getElementById("customerName").textContent = name || "Guest";
document.getElementById("totalPrice").textContent = "₱" + total.toLocaleString();
document.getElementById("priceBreakdown").textContent = 
  `₱${PRICE_PER_PERSON} × ${guests} guest(s)`;

async function pay(method) {
  if (method !== "GCash") {
    alert("Currently only GCash integration is supported.");
    return;
  }

  if (!bookingId) {
    alert("❌ Booking information missing. Please start over.");
    window.location.href = "../index.html";
    return;
  }

  try {
    const response = await fetch("https://qoronghxfdamvuxmbjqx.supabase.co/functions/v1/create-payment", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFvcm9uZ2h4ZmRhbXZ1eG1ianF4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMTA3NjksImV4cCI6MjA3NTg4Njc2OX0.YJqas5o80oWwfzkpbTQ3ci6CxTuQ_nkOobV6sg0NMXg"
      },
      body: JSON.stringify({
        name: name,
        amount: total * 100, // Convert to centavos for PayMongo
        description: `${bookingType === "regular" ? "Regular" : "VIP"} Booking for ${name}`,
        booking_id: bookingId
      })
    });

    const data = await response.json();
    const checkoutUrl = data?.data?.attributes?.checkout_url;
    
    if (checkoutUrl) {
      // Update booking status in the correct table
      const tableName = bookingType === "regular" ? "regular_bookings" : "vip_bookings";
      await client.from(tableName).update({ 
        status: "pending",
        payment_link_id: data.data.id 
      }).eq("id", bookingId);
      
      // Open PayMongo in new tab
      window.open(checkoutUrl, '_blank');
      
      alert('Payment window opened! After completing payment, click "Verify Payment" on the next page.');
      
      // Redirect with all parameters including type
      window.location.href = `payment-return.html?booking_id=${bookingId}&name=${encodeURIComponent(name)}&amount=${total}&type=${bookingType}`;
    } else {
      throw new Error("Invalid PayMongo response");
    }
  } catch (error) {
    console.error("Payment creation failed:", error);
    alert("❌ Unable to start payment. Please try again later.\n\nError: " + error.message);
  }
}

async function cancel() {
  if (!confirm("Are you sure you want to cancel this booking?")) return;
  
  try {
    const tableName = bookingType === "regular" ? "regular_bookings" : "vip_bookings";
    await client.from(tableName).update({ 
      status: "cancelled" 
    }).eq("id", bookingId);
    
    // Also delete VIP seats if applicable
    if (bookingType === "vip") {
      await client.from("vip_seats").delete().eq("booking_id", bookingId);
    }
    
    sessionStorage.removeItem('booking_info');
    alert("Booking cancelled.");
    window.location.href = "../index.html";
  } catch (error) {
    console.error("Cancellation error:", error);
    alert("Error cancelling booking. Please try again.");
  }
}
</script>
</body>
</html>